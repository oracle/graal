define(["exports","ojs/ojcore-base","ojs/ojlogger","ojs/ojdomscroller"],function(e,t,a,n){"use strict";class r{constructor(e,t,a){this.root=e,this.dataProvider=t,this.callback=a,this.validKeyTypes=["string","number"],this.fetching=0,this.getKey=function(e){return e.key},t&&(this.modelEventHandler=this._handleModelEvent.bind(this),t.addEventListener("mutate",this.modelEventHandler),t.addEventListener("refresh",this.modelEventHandler))}setFetching(e){const t=e?this.fetching+1:this.fetching-1;this.fetching=Math.max(0,t)}isFetching(){return 0!==this.fetching}destroy(){this.callback=null,this.dataProvider&&this.modelEventHandler&&(this.dataProvider.removeEventListener("mutate",this.modelEventHandler),this.dataProvider.removeEventListener("refresh",this.modelEventHandler))}render(){return null==this.callback.getData()&&this.fetchRows(),this.renderFetchedData()}postRender(){}getDataProvider(){return this.dataProvider}setDataProvider(e){this.dataProvider=e}isReady(){return!this.fetching}verifyKey(e){return this.validKeyTypes.indexOf(typeof e)>-1}handleModelRefresh(){this.callback.setData(null),this.fetchRows()}handleItemsAdded(e){}handleItemsRemoved(e){}handleItemsUpdated(e){}_handleModelEvent(e){if("refresh"===e.type)this.handleModelRefresh();else if("mutate"===e.type){const t=e.detail;t.add&&this.handleItemsAdded(t.add),t.remove&&this.handleItemsRemoved(t.remove),t.update&&this.handleItemsUpdated(t.update)}}}var i;(i=e.VirtualizationStrategy||(e.VirtualizationStrategy={}))[i.HIGH_WATER_MARK=0]="HIGH_WATER_MARK",i[i.VIEWPORT_ONLY=1]="VIEWPORT_ONLY";class s{constructor(e,t,a,n){this.element=e,this.dataProvider=t,this.asyncIterator=a,this.options=n,this._handleScroll=(e=>{const t=this.element,a=this._getScrollTop(t),n=t.scrollHeight-t.clientHeight;n>0&&this._handleScrollerScrollTop(a,n)}),this.initialScrollTop=this.element.scrollTop,this.scrollListener=this._handleScroll.bind(this),this._getScrollEventElement().addEventListener("scroll",this.scrollListener),this.fetchSize=n.fetchSize>0?n.fetchSize:25,this.maxCount=n.maxCount>0?n.maxCount:500,this.rowCount=n.initialRowCount>0?n.initialRowCount:0,this.successCallback=n.success,this.errorCallback=n.error,this.beforeFetchCallback=n.beforeFetchNext,this.beforeFetchByOffsetCallback=n.beforeFetchByOffset,this.viewportSize=-1,this.viewportPixelSize=this.element.offsetHeight,this.currentScrollTop=0,this.currentRenderedPoint={startIndex:0,endIndex:isNaN(this.rowCount)?this.fetchSize:this.rowCount,maxCountLimit:!1,done:!1,valid:!0},this.renderedPoints=[],this.lastFetchTrigger=0}checkViewport(){if(this.currentRenderedPoint.done||this.currentRenderedPoint.maxCountLimit)return!0;let e=this._isRangeValid(0,this.currentRenderedPoint.end);return e||this._doFetch(),e}_isRenderingViewportOnly(){return this.options.strategy===e.VirtualizationStrategy.VIEWPORT_ONLY}setViewportRange(e,t){if(null==this.currentRenderedPoint.start||null==this.currentRenderedPoint.end){this.currentRenderedPoint.start=e,this.currentRenderedPoint.end=t;const a=Object.assign({},this.currentRenderedPoint);this.renderedPoints.push(a),this._log("got pixel range: "+e+" to "+t+" for renderedPoint: "+this.currentRenderedPoint.startIndex+" "+this.currentRenderedPoint.endIndex)}else!1===this.currentRenderedPoint.valid&&(this._log("current rendered point was previous marked as invalid before: "+this.currentRenderedPoint.start+" - "+this.currentRenderedPoint.end),this.currentRenderedPoint.start=e,this.currentRenderedPoint.end=t,this.currentRenderedPoint.valid=!0,this._log("... and after: "+e+" to "+t+" for renderedPoint: "+this.currentRenderedPoint.startIndex+" "+this.currentRenderedPoint.endIndex),this._syncRenderedPointsWithCurrent());this._checkRenderedPoints()&&(this.fetchPromise=null,this.currentScrollTop>=this.lastFetchTrigger&&(this.nextFetchTrigger=void 0))}destroy(){this._getScrollEventElement().removeEventListener("scroll",this.scrollListener)}_getScrollEventElement(){return this.element===document.body||this.element===document.documentElement?window:this.element}_getScrollTop(e){return e===document.documentElement&&(void 0===this.useBodyScrollTop&&(this.useBodyScrollTop=this.initialScrollTop===e.scrollTop),this.useBodyScrollTop)?0+document.body.scrollTop:0+e.scrollTop}_setRangeLocal(e,t,a,n,r,i,s){this._log("rendering row: "+e+" to "+t+" covering range: "+(null==a?"unknown":a)+" to "+(null==n?"unknown":n)),this.beforeFetchByOffsetCallback(e,t),this.currentRenderedPoint={startIndex:e,endIndex:t,start:a,end:n,maxCountLimit:r,done:i,valid:s};const l={offset:e,size:t-e};this.fetchByOffsetPromise=this.dataProvider.fetchByOffset(l).then(s=>{let l=!0;if(null!=a&&null!=n&&(l=this._isRangeValid(a,n)),l){this._log("fetchByOffset "+e+" to "+t+" returned and result is still applicable");let a=[],n=[];s.results.forEach(e=>{a.push(e.data),n.push(e.metadata)});let l={};l.startIndex=e,l.maxCountLimit=r,l.done=i,l.value={},l.value.data=a,l.value.metadata=n,this.successCallback(l)}else this._log("fetchByOffset "+e+" to "+t+" returned but result is NO LONGER applicable");this.fetchByOffsetPromise=null})}_handleScrollerScrollTop(e,t){if(this.currentScrollTop=e,!this.fetchPromise&&this.asyncIterator){if(isNaN(this.nextFetchTrigger)&&this.lastMaxScrollTop!==t&&(this.nextFetchTrigger=Math.max(0,(t-e)/2),this.lastFetchTrigger=e,this.lastMaxScrollTop=t,this._log("next fetch trigger point: "+Math.round(this.nextFetchTrigger))),null!=this.nextFetchTrigger&&e-this.lastFetchTrigger>this.nextFetchTrigger)return void this._doFetch();if(t-e<1)return void this._doFetch()}this.fetchPromise&&e>this.lastFetchTrigger||this._checkRenderedPoints()}_isRangeValid(e,t){const a=this.currentScrollTop;return this.viewportPixelSize=this.element.offsetHeight,a>=e&&a+this.viewportPixelSize<=t}_checkRenderedPoints(){if(null==this.currentRenderedPoint.start||null==this.currentRenderedPoint.end)return!0;if(this._isRangeValid(this.currentRenderedPoint.start,this.currentRenderedPoint.end))return!0;for(let e=0;e<this.renderedPoints.length;e++){const t=this.renderedPoints[e];if(this._isRangeValid(t.start,t.end))return this._setRangeLocal(t.startIndex,t.endIndex,t.start,t.end,t.maxCountLimit,t.done,t.valid),!1}const e=this.currentScrollTop;this.viewportPixelSize=this.element.offsetHeight;for(let t=0;t<this.renderedPoints.length;t++){const a=this.renderedPoints[t];if(e>=a.start&&t<this.renderedPoints.length-1){const n=this.renderedPoints[t+1];if(e+this.viewportPixelSize<=n.end)return this._setRangeLocal(a.startIndex,n.endIndex,a.start,n.end,n.maxCountLimit,n.done,n.valid),!1}}return this._log("scroll position is not covered by at most 2 rendered points"),!0}_doFetch(){this._log("fetching next set of rows from asyncIterator");const e=this.currentScrollTop;let t=this._isRenderingViewportOnly()?this.beforeFetchCallback(e):0;t>-1?(-1===this.viewportSize&&(this.viewportSize=this.currentRenderedPoint.endIndex-this.currentRenderedPoint.startIndex),this.fetchPromise=this._fetchMoreRows().then(e=>{if((this._isRenderingViewportOnly()?this.beforeFetchCallback(this.currentScrollTop):0)>=t){if(e.maxCount){this._log("reached max count");let t=e.size>0?null:this.currentRenderedPoint.start,a=e.size>0?null:this.currentRenderedPoint.end;this._setRangeLocal(this.currentRenderedPoint.startIndex,this.maxCount,t,a,!0,!1,!0),this.fetchPromise=null,this.asyncIterator=null}else if(e.size>0||!0===e.done){const a=t,n=this.currentRenderedPoint.endIndex+e.size;this._setRangeLocal(a,n,null,null,!1,e.done,!0)}}else this._checkRenderedPoints()},e=>{this.errorCallback&&(this.errorCallback(e),this.fetchPromise=null,this.nextFetchTrigger=void 0)})):(this._log("fetch is aborted due to beforeFetchCallback returning false"),this.nextFetchTrigger=void 0)}_fetchMoreRows(){if(!this.fetchPromise){const e=this.maxCount-this.rowCount;return e>0&&this.asyncIterator?(this.fetchPromise=this.asyncIterator.next().then(t=>{let a;return this.fetchPromise=null,null!=t&&(a={done:t.done,maxCountLimit:t.maxCountLimit},null!=t.value&&(a.size=t.value.data.length,this.rowCount+=t.value.data.length,e<this.fetchSize&&(a.maxCountLimit=!0,t.value.data.length>e&&(a.size=e))),(a.done||a.maxCountLimit)&&(this.asyncIterator=null)),Promise.resolve(a)}),this.fetchPromise):Promise.resolve({maxCount:this.maxCount,maxCountLimit:!0})}return this.fetchPromise}_syncRenderedPointsWithCurrent(){this.renderedPoints.forEach(e=>{e.startIndex===this.currentRenderedPoint.startIndex&&(e.start=this.currentRenderedPoint.start),e.endIndex===this.currentRenderedPoint.endIndex&&(e.end=this.currentRenderedPoint.end),e.startIndex===this.currentRenderedPoint.startIndex&&e.endIndex===this.currentRenderedPoint.endIndex&&(e.valid=!0)})}_updateRenderedPoint(e,t,a){let n=!1;e<=t.startIndex?("added"===a?(t.startIndex=t.startIndex+1,t.endIndex=t.endIndex+1):"removed"===a&&(t.startIndex=t.startIndex-1,t.endIndex=t.endIndex-1),n=!0):e<=t.endIndex&&("added"===a?t.endIndex=t.endIndex+1:"removed"===a&&(t.endIndex=t.endIndex-1),n=!0),n&&(t.valid=!1)}_updateRenderedPoints(e,t){this.renderedPoints.forEach(a=>{this._updateRenderedPoint(e,a,t)})}_handleItemsAddedOrRemoved(e,t){e.forEach(e=>{this._updateRenderedPoint(e,this.currentRenderedPoint,t),this._updateRenderedPoints(e,t)})}handleItemsAdded(e){this._handleItemsAddedOrRemoved(e,"added"),this.rowCount=this.rowCount+e.length}handleItemsRemoved(e){this._handleItemsAddedOrRemoved(e,"removed"),this.rowCount=Math.max(0,this.rowCount-e.length)}handleItemsUpdated(e){let t=!1;e.forEach(e=>{e>=this.currentRenderedPoint.startIndex&&e<=this.currentRenderedPoint.endIndex&&(t=!0)}),t&&(this.currentRenderedPoint.start=null,this.currentRenderedPoint.end=null)}_log(e){a.info("[VirtualizeDomScroller]=> "+e)}}e.IteratingDataProviderContentHandler=class extends r{constructor(t,a,n,r){super(t,a,n),this.root=t,this.dataProvider=a,this.callback=n,this.scrollPolicyOptions=r,this.fetchRows=(()=>{if(this.isReady()){this.setFetching(!0);let e={clientId:this._clientId};e.size=this._isLoadMoreOnScroll()?this.getFetchSize():-1,this.dataProviderAsyncIterator=this.getDataProvider().fetchFirst(e)[Symbol.asyncIterator]();let t=this.dataProviderAsyncIterator.next(),a=e.size,n=e=>e.done||-1!==a||"function"==typeof this.getDataProvider().getPageCount?e:this.dataProviderAsyncIterator.next().then(function(t){return e.done=t.done,e.value.data=e.value.data.concat(t.value.data),e.value.metadata=e.value.metadata.concat(e.value.metadata),n(e)},function(e){this._handleFetchError(e)});t.then(e=>n(e),e=>{this._handleFetchError(e)}).then(e=>{if(this.isFetching()){if(null==this.callback)return;this.initialFetch=!0,this.callback.setData(e)}},e=>{this._handleFetchError(e)})}}),this._registerDomScroller=(()=>{let t={fetchSize:this.getFetchSize(),maxCount:this._getMaxCount(),initialRowCount:this.getFetchSize(),strategy:e.VirtualizationStrategy.HIGH_WATER_MARK,success:e=>{this.handleFetchSuccess(e)},error:e=>{this._handleFetchError(e)},beforeFetchNext:e=>this.handleBeforeFetchNext(e),beforeFetchByOffset:(e,t)=>{this.handleBeforeFetchByOffset(e,t)}};this.domScroller=new s(this._getScroller(),this.getDataProvider(),this.dataProviderAsyncIterator,t)}),this._clientId=Symbol()}postRender(){this.initialFetch=!1}destroy(){super.destroy(),this.domScroller&&this.domScroller.destroy()}_isLoadMoreOnScroll(){return!0}_getScroller(){const e=this.scrollPolicyOptions.scroller;return null!=e?e:this.root}getFetchSize(){return this.scrollPolicyOptions.fetchSize}_getMaxCount(){return this.scrollPolicyOptions.maxCount}isInitialFetch(){return this.initialFetch}renderSkeletonsForLoadMore(){}renderFetchedData(){if(null==this.callback)return;let e=this._renderOutOfRangeData();const t=this.callback.getData();if(null==t||null==t.value)return e;const n=t.value.data,r=t.value.metadata;return n.length===r.length?(e.push(this.renderData(n,r)),this._isLoadMoreOnScroll()&&(t.done||(0===n.length&&a.info("handleFetchedData: zero data returned while done flag is false"),t.maxCountLimit||(null==this.domScroller&&this._registerDomScroller(),e.push(this.renderSkeletonsForLoadMore()))),t.maxCountLimit&&this._handleScrollerMaxRowCount()),this.setFetching(!1),e):void 0}handleBeforeFetchNext(e){}handleBeforeFetchByOffset(e,t){}handleFetchSuccess(e){null!=e&&this.callback.setData(e)}_handleFetchError(e){a.error("an error occurred during data fetch, reason: "+e)}_handleScrollerMaxRowCount(){}renderData(e,t){if(null==this.callback)return null;let n=[];for(let r=0;r<e.length;r++){if(null==e[r]||null==t[r])continue;if(!this.verifyKey(t[r].key)){a.error("encounted a key with invalid data type.  Acceptable data types for key are: "+this.validKeyTypes),n=[];break}let i=this.addItem(t[r].key,r,e[r],!0);i&&n.push(i)}return n}_renderOutOfRangeData(){let e=[],t=this.callback.getOutOfRangeData();return null!=t&&t.forEach(t=>{const a=t.data,n=t.metadata,r=this.addItem(n.key,0,a,!1);r&&e.push(r)}),e}_handleItemsMutated(e,t,a,n,r){this.callback.updateData(function(i){let s={startIndex:i.startIndex,done:i.done,value:{data:i.value.data.slice(0),metadata:i.value.metadata.slice(0)}},l=[],d=e.indexes;const h=Array.from(e[t]);null==d&&(d=h.map(e=>this._findIndex(i.value.metadata,e))),this.domScroller&&a(d);const o=isNaN(i.startIndex)?0:i.startIndex,c=Math.max(o+i.value.data.length,this.getFetchSize());return d.forEach((t,a)=>{const i=h[a],d=null!=e.data?e.data[a]:null,u=null!=e.metadata?e.metadata[a]:null;t>=o&&t<=c?n(s,i,t,d,u):r&&l.push({data:d,metadata:u})}),r?{outOfRangeData:l,renderedData:s}:{renderedData:s}}.bind(this))}_findIndex(e,a){for(let n=0;n<e.length;n++)if(t.KeyUtils.equals(a,e[n].key))return n;return-1}handleModelRefresh(){this.domScroller&&this.domScroller.destroy(),this.domScroller=null,super.handleModelRefresh()}handleItemsAdded(e){this.callback.updateData(function(t){let a={startIndex:t.startIndex,done:t.done,maxCountLimit:t.maxCountLimit,value:{data:t.value.data.slice(0),metadata:t.value.metadata.slice(0)}},n=[],r=e.indexes;const i=e.addBeforeKeys,s=e.keys;if(null==r&&null==i)a.done&&!a.maxCountLimit&&(a.value.data.push(e.data),a.value.metadata.push(e.metadata));else{let t=0;s.forEach(function(){const s=e.data[t],l=e.metadata[t];let d=-1;null!=i&&null!=i[t]?d=this._findIndex(a.value.metadata,i[t]):null!=r&&null!=r[t]&&(d=r[t]),d>-1&&d<=a.value.data.length?(a.value.data.splice(d,0,s),a.value.metadata.splice(d,0,l)):a.done&&!a.maxCountLimit?(a.value.data.push(s),a.value.metadata.push(l)):n.push({data:s,metadata:l}),t++}.bind(this))}return this.domScroller&&this.domScroller.handleItemsAdded&&this.domScroller.handleItemsAdded(r),{renderedData:a,outOfRangeData:n}}.bind(this)),super.handleItemsAdded(e)}handleItemsRemoved(e){this._handleItemsMutated(e,"keys",e=>{this.domScroller.handleItemsRemoved(e)},(e,t)=>{let a=this._findIndex(e.value.metadata,t);a>-1&&(e.value.data.splice(a,1),e.value.metadata.splice(a,1))},!1),super.handleItemsRemoved(e)}handleCurrentRangeItemUpdated(e){}handleItemsUpdated(e){this._handleItemsMutated(e,"keys",e=>{this.domScroller.handleItemsUpdated(e)},(e,t,a,n,r)=>{e.value.data.splice(a,1,n),e.value.metadata.splice(a,1,r),this.handleCurrentRangeItemUpdated(t)},!0),super.handleItemsUpdated(e)}},e.IteratingTreeDataProviderContentHandler=class extends r{constructor(t,a,r,i){super(t,a,r),this.root=t,this.dataProvider=a,this.callback=r,this.scrollPolicyOptions=i,this.fetchRows=(()=>{if(this.isReady()){let e={clientId:this._clientId};e.size=this._isLoadMoreOnScroll()?this.getFetchSize():-1;let t=this.getDataProvider().fetchFirst(e)[Symbol.asyncIterator]();this._cachedIteratorsAndResults.root={iterator:t,cache:null};let a={value:{data:[],metadata:[]}};this._fetchNextFromIterator(t,null,e,a).then(this._setNewData)}}),this._fetchNextFromIterator=((e,t,a,n)=>{if(null==e)return Promise.resolve();this.setFetching(!0);let r=e.next(),i=a.size,s=t=>t.done||-1!==i||"function"==typeof this.getDataProvider().getPageCount?t:e.next().then(function(e){return t.done=e.done,t.value.data=t.value.data.concat(e.value.data),t.value.metadata=t.value.metadata.concat(t.value.metadata),s(t)},function(e){this._handleFetchError(e)});return r.then(e=>s(e),()=>{this._handleFetchError()}).then(e=>{if(this.isFetching()){if(this.setFetching(!1),null==this.callback||null==e)return;return this.initialFetch=!0,e.done&&this._cachedIteratorsAndResults[null===t?"root":t]&&(this._cachedIteratorsAndResults[null===t?"root":t].iterator=null),this.handleNextItemInResults(a,t,e,n)}},()=>{this._handleFetchError()})}),this._setNewData=(e=>{null!=this.callback&&this.callback.updateData(function(t){let a,n=e.value.data,r=e.value.metadata;return{renderedData:a=null==t?{value:{data:n,metadata:r},done:this._checkIteratorAndCache()}:{value:{data:t.value.data.concat(n),metadata:t.value.metadata.concat(r)},done:this._checkIteratorAndCache()}}}.bind(this))}),this._checkIteratorAndCache=(()=>{let e=this._cachedIteratorsAndResults,t=Object.keys(e).map(function(t){return e[t]}),a=!0;return t.forEach(function(e){!e||null==e.iterator&&null==e.cache||(a=!1)}),a}),this.fetchMoreRows=(()=>{if(this.isReady()){let e=this._getLastEntryMetadata(),t=e.key;!e.isLeaf&&this._isExpanded(t)||(t=e.parentKey);let a={};a.size=this._isLoadMoreOnScroll()?this.getFetchSize():-1;let n=this._cachedIteratorsAndResults[null===t?"root":t],r=null,i=null;null!=n&&(r=n.cache,i=n.iterator);let s={value:{data:[],metadata:[]}};return this.handleNextItemInResults(a,t,r,s).then(this._fetchFromAncestors.bind(this,a,t,i,s))}return Promise.resolve()}),this._fetchFromAncestors=((e,t,a,n)=>{let r=this;return this._fetchNextFromIterator(a,t,e,n).then(function(t,a){if(r._checkFinalResults(e,a)||null===t)return a.done=this._checkIteratorAndCache(),Promise.resolve(a);let n=r._getItemByKey(t,a).metadata.parentKey,i=this._cachedIteratorsAndResults[null===n?"root":n],s=null,l=null;return null!=i&&(s=i.cache,l=i.iterator),this.handleNextItemInResults(e,n,s,a).then(this._fetchFromAncestors.bind(this,e,n,l,a))}.bind(this,t,n))}),this._getLastEntryMetadata=(()=>{let e=this.callback.getData();if(e&&e.value.metadata.length){let t=e.value.metadata;return t[t.length-1]}return null}),this._isExpanded=(e=>this.callback.getExpanded().has(e)),this.getChildDataProvider=(e=>null==e?this.dataProvider:this.dataProvider.getChildDataProvider(e)),this.handleNextItemInResults=((e,t,a,n)=>{if(null===a||0===a.value.data.length||this._checkFinalResults(e,n))return null!=a&&a.value.data.length?this._cachedIteratorsAndResults[null===t?"root":t]&&(this._cachedIteratorsAndResults[null===t?"root":t].cache=a):this._cachedIteratorsAndResults[null===t?"root":t]&&(this._cachedIteratorsAndResults[null===t?"root":t].cache=null),n.done=this._checkIteratorAndCache(),Promise.resolve(n);let r=a.value.data.shift(),i=a.value.metadata.shift(),s=this._updateMetadata(i,t,n);if(n.value.data.push(r),n.value.metadata.push(s),this._isExpanded(s.key)){let e=this.getChildDataProvider(s.key);if(null!=e){let r={clientId:this._clientId};r.size=this._isLoadMoreOnScroll()?this.getFetchSize():-1;let i=e.fetchFirst(r)[Symbol.asyncIterator]();return this._cachedIteratorsAndResults[null===s.key?"root":s.key]={iterator:i,cache:null},this._fetchNextFromIterator(i,s.key,r,n).then(this.handleNextItemInResults.bind(this,r,t,a,n))}}return this.handleNextItemInResults(e,t,a,n)}),this._checkFinalResults=((e,t)=>t.value.data.length>=e.size&&-1!==e.size),this._updateMetadata=((e,t,a)=>{let n=0,r=this._getLastItemByParentKey(t,a),i=null==r?0:r.metadata.indexFromParent+1,s=null===this.getChildDataProvider(e.key);null!=t&&(n=this._getItemByKey(t,a).metadata.treeDepth+1);let l=this._isExpanded(e.key);return{key:e.key,isLeaf:s,parentKey:t,indexFromParent:i,treeDepth:n,expanded:l}}),this._getIndexByKey=((e,t)=>{var a=-1;return t.some(function(t,n){if(t.key===e)return a=n,!0}),a}),this._getLastItemByParentKey=((e,t)=>{var a=null;if(t&&t.value.metadata.slice().reverse().some(function(n,r){if(n.parentKey===e)return a={data:t.value.data[r],metadata:n},!0}),a)return a;let n=this.callback.getData();return n&&n.value.metadata.slice().reverse().some(function(t,r){if(t.parentKey===e)return a={data:n.value.data[r],metadata:t},!0}),a}),this._getItemByKey=((e,t)=>{var a=null;if(t&&t.value.metadata.some(function(n,r){if(n.key===e)return a={data:t.value.data[r],metadata:n},!0}),a)return a;let n=this.callback.getData();return n&&n.value.metadata.some(function(t,r){if(t.key===e)return a={data:n.value.data[r],metadata:t},!0}),a}),this.expand=(e=>{let t=this.getChildDataProvider(e);if(null===t)return;let a=setTimeout(function(){this.callback.getExpandingKeys().has(e)&&this.callback.updateSkeletonKeys(e)}.bind(this),250),n={clientId:this._clientId,size:-1},r=t.fetchFirst(n)[Symbol.asyncIterator]();return this._fetchNextFromIterator(r,e,n,{value:{data:[],metadata:[]}}).then(function(t){null!=this.callback&&this.callback.updateExpand(function(n,r,i,s){if(a&&clearTimeout(a),r.has(e)&&(r=r.delete([e])),!i.has(e)||!s.has(e))return{expandedSkeletonKeys:r};if(null==t)return{expandedSkeletonKeys:r,expandingKeys:i.delete([e])};let l,d=t.value.data,h=t.value.metadata;if(n){let t=n.value.data,a=n.value.metadata,r=this._getIndexByKey(e,a);-1!==r&&(l={value:{data:t.slice(0,r+1).concat(d,t.slice(r+1)),metadata:a.slice(0,r+1).concat(h,a.slice(r+1))},done:n.done})}return null==l&&(l={value:{data:d,metadata:h},done:!0}),{expandedSkeletonKeys:r,expandingKeys:i=i.delete([e]),renderedData:l}}.bind(this))}.bind(this))}),this.collapse=((e,t)=>{let a=t.value.data,n=t.value.metadata,r=this._findIndex(n,e);if(r>-1){let e=this._getLocalDescendentCount(n,r);a.splice(r+1,e),n.splice(r+1,e)}return{value:{data:a,metadata:n},done:t.done}}),this._getLocalDescendentCount=((e,t)=>{let a=0,n=e[t].treeDepth,r=e.length;for(let i=t+1;i<r;i++){if(!(e[i].treeDepth>n))return a;a+=1}return a}),this._registerDomScroller=(()=>{let t={asyncIterator:{next:this.fetchMoreRows.bind(this)},fetchSize:this.getFetchSize(),fetchTrigger:this.callback.getSkeletonHeight()*this.getLoadMoreCount(),maxCount:this._getMaxCount(),initialRowCount:this.getFetchSize(),strategy:e.VirtualizationStrategy.HIGH_WATER_MARK,success:e=>{this.handleFetchSuccess(e)},error:()=>{this._handleFetchError()},beforeFetch:()=>this.handleBeforeFetchNext(),beforeFetchByOffset:()=>{this.handleBeforeFetchByOffset()}};this.domScroller=new n(this._getScroller(),this.getDataProvider(),t)}),this.getLoadMoreCount=(()=>0),this._cachedIteratorsAndResults={},this._clientId=Symbol()}postRender(){this.initialFetch=!1}destroy(){super.destroy(),this.domScroller&&this.domScroller.destroy()}_isLoadMoreOnScroll(){return!0}_getScroller(){const e=this.scrollPolicyOptions.scroller;return null!=e?e:this.root}getFetchSize(){return this.scrollPolicyOptions.fetchSize}_getMaxCount(){return this.scrollPolicyOptions.maxCount}isInitialFetch(){return this.initialFetch}renderSkeletonsForLoadMore(){}renderSkeletonsForExpand(e){}renderFetchedData(){if(null==this.callback)return;let e=this._renderOutOfRangeData();const t=this.callback.getData();if(null==t||null==t.value)return e;const n=t.value.data,r=t.value.metadata;return n.length===r.length?(e.push(this.renderData(n,r)),this._isLoadMoreOnScroll()&&(t.done||(0===n.length&&a.info("handleFetchedData: zero data returned while done flag is false"),t.maxCountLimit||(null==this.domScroller&&this._registerDomScroller(),e.push(this.renderSkeletonsForLoadMore()))),t.maxCountLimit&&this._handleScrollerMaxRowCount()),e):void 0}handleBeforeFetchNext(){return!this.isFetching()}handleBeforeFetchByOffset(){}handleFetchSuccess(e){null!=e&&this._setNewData(e)}_handleFetchError(){this.setFetching(!1)}_handleScrollerMaxRowCount(){}renderData(e,t){if(null==this.callback)return null;let n=[],r=this.callback.getSkeletonKeys();for(let i=0;i<e.length;i++){if(null==e[i]||null==t[i])continue;if(!this.verifyKey(t[i].key)){a.error("encounted a key with invalid data type.  Acceptable data types for key are: "+this.validKeyTypes),n=[];break}let s=this.addItem(t[i],i,e[i],!0);s&&(n.push(s),r.has(t[i].key)&&n.push(this.renderSkeletonsForExpand(t[i].key)))}return n}_renderOutOfRangeData(){return[]}_handleItemsMutated(e,t,a,n){null!=this.callback&&this.callback.updateData(function(r,i){let s=i,l={startIndex:r.startIndex,done:r.done,value:{data:r.value.data.slice(0),metadata:r.value.metadata.slice(0)}};const d=Array.from(e[t]);let h=d.map(e=>this._findIndex(r.value.metadata,e));this.domScroller&&a(h);const o=isNaN(r.startIndex)?0:r.startIndex,c=Math.max(o+r.value.data.length,this.getFetchSize());let u=!1;if(h.forEach((t,a)=>{const r=d[a],i=null!=e.data?e.data[a]:null,h=null!=e.metadata?e.metadata[a]:null;if(t>=o&&t<=c){let e=n(l,r,t,i,h,s);null!=e&&(s=e),u=!0}}),u)return s!==i?{renderedData:l,expandingKeys:s}:{renderedData:l}}.bind(this))}_findIndex(e,a){for(let n=0;n<e.length;n++)if(t.KeyUtils.equals(a,e[n].key))return n;return-1}handleModelRefresh(){this.domScroller&&this.domScroller.destroy(),this.domScroller=null,this._cachedIteratorsAndResults={},super.handleModelRefresh()}handleItemsAdded(e){null!=this.callback&&(this.callback.updateData(function(t,a){let n={startIndex:t.startIndex,done:t.done,maxCountLimit:t.maxCountLimit,value:{data:t.value.data.slice(0),metadata:t.value.metadata.slice(0)}},r=e.indexes;const i=e.addBeforeKeys,s=e.parentKeys;let l,d=[];return null==r&&null==i&&null==s?n.done&&!n.maxCountLimit&&(n.value.data.push(e.data),l=this._updateMetadata(e.metadata,null,n),n.value.metadata.push(l)):null!=s&&(null==r&&(r=[]),s.forEach(function(t,a){const s=e.data[a],h=e.metadata[a];let o=-1;if(null===t||this._isExpanded(t)&&this._getItemByKey(t))if(null!=i)o=null!=i[a]?this._findIndex(n.value.metadata,i[a]):this._findIndex(n.value.metadata,this._getLastItemByParentKey(t).metadata.key)+1;else if(null!=r){let e=this._findIndex(n.value.metadata,t);o=-1===e?r[a]+1:e+r[a]+1}else o=this._findIndex(n.value.metadata,this._getLastItemByParentKey(t).metadata.key)+1;o>-1?(n.value.data.splice(o,0,s),l=this._updateMetadata(h,t,n),n.value.metadata.splice(o,0,l),-1===r.indexOf(o)&&r.push(o),this._isExpanded(h.key)&&d.push(h.key)):n.done&&!n.maxCountLimit&&(n.value.data.push(s),n.value.metadata.push(h))}.bind(this))),this.domScroller&&this.domScroller.handleItemsAdded&&this.domScroller.handleItemsAdded(r),{expandingKeys:a.add(d),renderedData:n}}.bind(this)),super.handleItemsAdded(e))}handleItemsRemoved(e){this._handleItemsMutated(e,"keys",e=>{this.domScroller.handleItemsRemoved&&this.domScroller.handleItemsRemoved(e)},(e,t)=>{let a=this._findIndex(e.value.metadata,t);if(a>-1){let t=this._getLocalDescendentCount(e.value.metadata,a)+1;e.value.data.splice(a,t),e.value.metadata.splice(a,t)}}),super.handleItemsRemoved(e)}handleCurrentRangeItemUpdated(){}handleItemsUpdated(e){this._handleItemsMutated(e,"keys",e=>{this.domScroller.handleItemsUpdated&&this.domScroller.handleItemsUpdated(e)},(e,t,a,n,r,i)=>{let s=e.value.metadata[a],l=s.isLeaf,d=this._updateMetadata(r,s.parentKey,{value:{data:[n],metadata:[r]}});return l&&!d.isLeaf&&(i=i.add([d.key])),e.value.data.splice(a,1,n),e.value.metadata.splice(a,1,d),this.handleCurrentRangeItemUpdated(),i}),super.handleItemsUpdated(e)}checkViewport(){if(this.domScroller&&this.isReady()){let e=this.domScroller.checkViewport();null!=e&&e.then(function(e){null!=e&&this.handleFetchSuccess(e)}.bind(this))}}},e.KeyedElement=class extends HTMLElement{},e.VirtualizeDomScroller=s,Object.defineProperty(e,"__esModule",{value:!0})});