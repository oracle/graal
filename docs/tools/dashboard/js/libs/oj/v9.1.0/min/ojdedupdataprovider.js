/**
 * @license
 * Copyright (c) 2014, 2020, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["ojs/ojcore","jquery","ojs/ojdataprovider","ojs/ojcachediteratorresultsdataprovider","ojs/ojcomponentcore","ojs/ojeventtarget"],function(t,e,a,i){"use strict";class s{constructor(e){this.dataProvider=e,this.DedupAsyncIterable=class{constructor(t,e,a,i){this._parent=t,this.params=e,this.dataProviderAsyncIterator=a,this.cache=i,this[Symbol.asyncIterator]=(()=>new this._parent.DedupAsyncIterator(this._parent,this.params,this.dataProviderAsyncIterator,this.cache))}},this.DedupAsyncIterator=class{constructor(t,e,a,i){this._parent=t,this.params=e,this.asyncIterator=a,this.cache=i,this._cachedOffset=0}next(){let e=this,a=new Set;if(this.params.size>0){this._parent.cache.getDataByOffset({offset:0,size:this._cachedOffset}).results.forEach(function(t){a.add(t.metadata.key)})}return this.asyncIterator.next().then(r=>{let n=r[s._VALUE],d=n.metadata.map(function(t){return t[s._KEY]});this._cachedOffset=this._cachedOffset+d.length;let h=new Set;d.forEach(function(t){h.add(t)});let c=[],o=[],p=[];if(h.forEach(function(t,e){a.has(t)&&(c.push(t),o.push(n.data[e]),p.push(n.metadata[e]))}),c.length>0){let a=new Set;c.map(function(t){a.add(t)});let i=new e._parent.DataProviderOperationEventDetail(e._parent,a,p,o,[]),s=new e._parent.DataProviderMutationEventDetail(e._parent,null,i,null);e._parent.dispatchEvent(new t.DataProviderMutationEvent(s))}return e._parent.dataProvider instanceof i||e._parent.cache.addListResult(r),r})}},this.DataProviderMutationEventDetail=class{constructor(t,e,a,i){this._parent=t,this.add=e,this.remove=a,this.update=i,this[s._ADD]=e,this[s._REMOVE]=a,this[s._UPDATE]=i}},this.DataProviderOperationEventDetail=class{constructor(t,e,a,i,r){this._parent=t,this.keys=e,this.metadata=a,this.data=i,this.indexes=r,this[s._KEYS]=e,this[s._METADATA]=a,this[s._DATA]=i,this[s._INDEXES]=r}};let r=this;this.cache=e instanceof i?e.cache:new a.DataCache,e.createOptimizedKeyMap&&(this.createOptimizedKeyMap=(t=>e.createOptimizedKeyMap(t))),e.createOptimizedKeySet&&(this.createOptimizedKeySet=(t=>e.createOptimizedKeySet(t))),e.addEventListener(s._MUTATE,t=>{t.detail&&t.detail.add&&this._processAddMutations(t.detail.add),r.dispatchEvent(t)}),e.addEventListener(s._REFRESH,t=>{r.cache.reset(),r.dispatchEvent(t)})}containsKeys(t){return this.dataProvider.containsKeys(t)}fetchByKeys(t){return this.dataProvider.fetchByKeys(t)}fetchByOffset(t){return this.dataProvider.fetchByOffset(t)}fetchFirst(t){const e=this.dataProvider.fetchFirst(t);return new this.DedupAsyncIterable(this,t,e[Symbol.asyncIterator](),this.cache)}getCapability(t){let e=this.dataProvider.getCapability(t);return"dedup"===t?{type:"iterator"}:e}getTotalSize(){return this.dataProvider.getTotalSize()}isEmpty(){return this.dataProvider.isEmpty()}_processAddMutations(e){let a=this,i=e[s._KEYS];if(i&&i.size>0){let e=new Set,s=[],r=[];if(this.cache.getDataByKeys({keys:i}).results.forEach(function(t,a){e.add(a),s.push(t.data),r.push(t.metadata)}),e.size>0){let i=new a.DataProviderOperationEventDetail(a,e,r,s,[]),n=new a.DataProviderMutationEventDetail(a,null,i,null);a.dispatchEvent(new t.DataProviderMutationEvent(n))}}}}
/**
 * @preserve Copyright 2013 jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 */
return s._KEY="key",s._KEYS="keys",s._DATA="data",s._METADATA="metadata",s._ITEMS="items",s._FROM="from",s._OFFSET="offset",s._REFRESH="refresh",s._MUTATE="mutate",s._SIZE="size",s._FETCHPARAMETERS="fetchParameters",s._VALUE="value",s._DONE="done",s._RESULTS="results",s._ADD="add",s._UPDATE="update",s._REMOVE="remove",s._INDEXES="indexes",t.DedupDataProvider=s,t.DedupDataProvider=s,t.EventTargetMixin.applyMixin(s),s});